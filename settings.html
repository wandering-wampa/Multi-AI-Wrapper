<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'none'; object-src 'none'; frame-ancestors 'none'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self';">
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: #111;
      --panel-2: #161616;
      --text: #e6e6e6;
      --muted: #9a9a9a;
      --accent: #3b82f6;
      --border: #242424;
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.12);
    }

    body {
      margin: 0;
      height: 100vh;
      background: rgba(0, 0, 0, 0.55);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      width: 900px;
      height: 560px;
      background: var(--bg);
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      display: flex;
      overflow: hidden;
    }

    .nav {
      width: 220px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 12px 8px;
    }

    .nav-title {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      padding: 8px 12px;
      letter-spacing: 0.06em;
    }

    .nav-item {
      padding: 10px 12px;
      margin: 2px 4px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .nav-item:hover { background: var(--panel-2); }

    .nav-item.active {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent);
    }

    .content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .content-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      font-size: 18px;
      font-weight: 600;
    }

    .content-body {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .section {
      max-width: 680px;
      margin-bottom: 28px;
    }

    .section h3 {
      margin: 0 0 6px 0;
      font-size: 15px;
      font-weight: 600;
    }

    .section p {
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 14px;
    }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      margin-top: 10px;
    }

    .row-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .row-title {
      font-size: 14px;
      font-weight: 600;
    }

    .row-subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .radio-group {
      display: flex;
      gap: 16px;
    }

    .radio {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    /* simple toggle */
    .toggle {
      position: relative;
      width: 44px;
      height: 24px;
      display: inline-block;
    }
    .toggle input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #2a2a2a;
      border: 1px solid var(--border);
      border-radius: 999px;
      transition: 0.15s;
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      top: 2px;
      background: #d8d8d8;
      border-radius: 999px;
      transition: 0.15s;
    }
    .toggle input:checked + .slider {
      background: rgba(59,130,246,0.35);
      border-color: rgba(59,130,246,0.45);
    }
    .toggle input:checked + .slider:before { transform: translateX(20px); }

    select {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      min-width: 220px;
    }

    input[type="text"] {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }

    /* checkbox list */
    .checklist {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }

    .checkrow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
    }

    .checkrow:first-child { border-top: none; }

    .checkrow label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      min-width: 0;
    }

    .checkrow .hint {
      color: var(--muted);
      font-size: 12px;
      font-weight: 400;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }

    .checkrow .left {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .checkrow .subhint {
      color: var(--muted);
      font-size: 12px;
      font-weight: 400;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 420px;
    }

    .checkrow .right {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
    }

    .icon-btn:hover {
      background: rgba(255,255,255,0.06);
    }

    .icon-btn.danger {
      border-color: rgba(239,68,68,0.35);
      background: var(--danger-bg);
      color: #ffb4b4;
    }

    .icon-btn.danger:hover {
      border-color: rgba(239,68,68,0.55);
      background: rgba(239, 68, 68, 0.18);
    }

    .btn {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover { background: #1d1d1d; }

    .btn.primary {
      border-color: rgba(59,130,246,0.45);
      background: rgba(59,130,246,0.18);
      color: #cfe2ff;
    }

    .btn.primary:hover {
      border-color: rgba(59,130,246,0.65);
      background: rgba(59,130,246,0.24);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .inline-form {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
      padding: 12px;
      display: none;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .form-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-label {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 6px 0;
    }

    .error-text {
      color: #ffb4b4;
      font-size: 12px;
      margin-top: 10px;
      display: none;
    }

    /* shortcuts list */
    .shortcuts {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }

    .shortcut-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      font-size: 14px;
    }
    .shortcut-row:first-child { border-top: none; }

    .kbd {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: var(--text);
    }

    .key {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-bottom-color: #333;
      border-radius: 6px;
      background: rgba(0,0,0,0.25);
      box-shadow: inset 0 -1px 0 rgba(255,255,255,0.06);
    }

    /* about */
    .kv {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }

    .kv-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      font-size: 14px;
    }
    .kv-row:first-child { border-top: none; }

    .kv-key { color: var(--muted); }
    .kv-val { font-weight: 600; }

    .links {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }

    .link-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      font-size: 14px;
    }
    .link-row:first-child { border-top: none; }

    .link-pill {
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.2);
    }

    .footer {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
    }

    .close-btn {
      background: var(--panel-2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 14px;
      cursor: pointer;
    }

    .close-btn:hover { background: #1d1d1d; }

    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body>
  <div class="modal">
    <div class="nav">
      <div class="nav-title">Settings</div>
      <div class="nav-item active" data-page="general">General</div>
      <div class="nav-item" data-page="models">Models</div>
      <div class="nav-item" data-page="behavior">Behavior</div>
      <div class="nav-item" data-page="about">About</div>
    </div>

    <div class="content">
      <div class="content-header" id="page-title">General</div>

      <div class="content-body">
        <!-- General -->
        <div class="page active" id="page-general">
          <div class="section">
            <h3>Theme</h3>
            <p>Choose how the application appearance is determined.</p>

            <div class="radio-group" id="themeRadios">
              <label class="radio">
                <input type="radio" name="theme" value="system">
                System
              </label>
              <label class="radio">
                <input type="radio" name="theme" value="light">
                Light
              </label>
              <label class="radio">
                <input type="radio" name="theme" value="dark">
                Dark
              </label>
            </div>
          </div>

          <div class="section">
            <h3>Startup behavior</h3>
            <p>Control which model is selected when the app starts.</p>

            <div class="row">
              <div class="row-left">
                <div class="row-title">Restore last active model on launch</div>
                <div class="row-subtitle">If off, use a fixed default model.</div>
              </div>
              <label class="toggle" title="Restore last active model on launch">
                <input id="restoreLastToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="row" id="defaultModelRow" style="display:none;">
              <div class="row-left">
                <div class="row-title">Default model</div>
                <div class="row-subtitle">Used when restore-last is disabled.</div>
              </div>

              <select id="defaultModelSelect" aria-label="Default model">
                <!-- populated dynamically -->
              </select>
            </div>
          </div>
        </div>

        <!-- Models -->
        <div class="page" id="page-models">
          <div class="section">
            <h3>Models</h3>
            <p>Enable/disable models, delete any model, or add a new URL.</p>

            <div class="checklist" id="modelsList" aria-label="Models list"></div>

            <div style="margin-top: 12px; display:flex; justify-content:flex-end;">
              <button class="btn primary" id="addModelBtn">+ Add model</button>
            </div>

            <div class="inline-form" id="addModelForm">
              <div class="form-grid">
                <div>
                  <div class="form-label">Model name</div>
                  <input id="addModelName" type="text" placeholder="e.g. DeepSeek" autocomplete="off" />
                </div>

                <div>
                  <div class="form-label">Model URL (must start with https://)</div>
                  <input id="addModelUrl" type="text" placeholder="https://example.com/" autocomplete="off" />
                </div>
              </div>

              <div class="error-text" id="modelsError"></div>

              <div class="form-actions">
                <button class="btn" id="cancelAddBtn" type="button">Cancel</button>
                <button class="btn primary" id="saveAddBtn" type="button">Add</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Behavior -->
        <div class="page" id="page-behavior">
          <div class="section">
            <h3>Reload / Stop behavior</h3>
            <p>Adjust confirmation and refresh behavior.</p>

            <div class="row">
              <div class="row-left">
                <div class="row-title">Confirm before stopping a loading model</div>
                <div class="row-subtitle">Prompts before stopping if the model is currently loading.</div>
              </div>
              <label class="toggle" title="Confirm before stopping a loading model">
                <input id="confirmBeforeStopToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="row">
              <div class="row-left">
                <div class="row-title">Hard reload on manual refresh</div>
                <div class="row-subtitle">Uses reload ignoring cache when you refresh from the UI.</div>
              </div>
              <label class="toggle" title="Hard reload on manual refresh">
                <input id="hardReloadToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="section">
            <h3>Keyboard shortcuts</h3>
            <p>Current shortcuts (read-only for now).</p>

            <div class="shortcuts" aria-label="Keyboard shortcuts list">
              <div class="shortcut-row">
                <div>Next model</div>
                <div class="kbd"><span class="key">Ctrl</span><span class="key">Tab</span></div>
              </div>
              <div class="shortcut-row">
                <div>Previous model</div>
                <div class="kbd"><span class="key">Ctrl</span><span class="key">Shift</span><span class="key">Tab</span></div>
              </div>
              <div class="shortcut-row">
                <div>Reload model</div>
                <div class="kbd"><span class="key">Ctrl</span><span class="key">R</span></div>
              </div>
              <div class="shortcut-row">
                <div>Stop loading</div>
                <div class="kbd"><span class="key">Esc</span></div>
              </div>
              <div class="shortcut-row">
                <div>Open settings</div>
                <div class="kbd"><span class="key">Ctrl</span><span class="key">,</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- About -->
        <div class="page" id="page-about">
          <div class="section">
            <h3>Application</h3>
            <p>Version and runtime information.</p>

            <div class="kv">
              <div class="kv-row">
                <div class="kv-key">App name</div>
                <div class="kv-val" id="aboutAppName">—</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">App version</div>
                <div class="kv-val" id="aboutAppVersion">—</div>
              </div>
              <div class="kv-row">
                <div class="kv-key">Electron version</div>
                <div class="kv-val" id="aboutElectronVersion">—</div>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Links</h3>
            <p>Placeholders for later (no navigation yet).</p>

            <div class="links">
              <div class="link-row">
                <div>Release notes</div>
                <div class="link-pill">placeholder</div>
              </div>
              <div class="link-row">
                <div>Documentation</div>
                <div class="link-pill">placeholder</div>
              </div>
              <div class="link-row">
                <div>Report an issue</div>
                <div class="link-pill">placeholder</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <button class="close-btn" id="closeBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Nav switching
    // -----------------------------
    const navItems = document.querySelectorAll(".nav-item");
    const pages = document.querySelectorAll(".page");
    const title = document.getElementById("page-title");

    navItems.forEach(item => {
      item.addEventListener("click", () => {
        navItems.forEach(i => i.classList.remove("active"));
        item.classList.add("active");

        const page = item.dataset.page;
        pages.forEach(p => p.classList.remove("active"));
        document.getElementById(`page-${page}`).classList.add("active");

        title.textContent = item.textContent;
      });
    });

    document.getElementById("closeBtn").addEventListener("click", () => {
      window.electronAPI.closeSettings();
    });

    // -----------------------------
    // Theme wiring
    // -----------------------------
    const themeRadios = document.querySelectorAll('input[name="theme"]');
    function setThemeRadios(source) {
      themeRadios.forEach(r => r.checked = (r.value === source));
    }

    themeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.checked) window.electronAPI.setTheme(radio.value);
      });
    });

    window.electronAPI.onThemeChanged(payload => {
      if (payload?.source) setThemeRadios(payload.source);
    });

    // -----------------------------
    // Local caches
    // -----------------------------
    let lastSettings = null;
    let lastModelsPayload = null;

    function modelsById(payload) {
      const map = Object.create(null);
      const list = Array.isArray(payload?.models) ? payload.models : [];
      for (const m of list) {
        if (!m || typeof m !== "object") continue;
        if (typeof m.id !== "string" || !m.id) continue;
        map[m.id] = m;
      }
      return map;
    }

    function computeOrderedIds(payload) {
      const order = Array.isArray(payload?.modelOrder) ? payload.modelOrder : [];
      const enabled = new Set(Array.isArray(payload?.enabledModels) ? payload.enabledModels : []);
      const byId = modelsById(payload);

      const out = [];
      const seen = new Set();

      // enabled first, in order
      for (const id of order) {
        if (!byId[id]) continue;
        if (!enabled.has(id)) continue;
        if (seen.has(id)) continue;
        seen.add(id);
        out.push(id);
      }

      // then disabled, in order
      for (const id of order) {
        if (!byId[id]) continue;
        if (enabled.has(id)) continue;
        if (seen.has(id)) continue;
        seen.add(id);
        out.push(id);
      }

      // ensure any missing ids are appended
      for (const id of Object.keys(byId)) {
        if (seen.has(id)) continue;
        seen.add(id);
        out.push(id);
      }

      return out;
    }

    // -----------------------------
    // Startup behavior wiring
    // -----------------------------
    const restoreLastToggle = document.getElementById("restoreLastToggle");
    const defaultModelRow = document.getElementById("defaultModelRow");
    const defaultModelSelect = document.getElementById("defaultModelSelect");

    function renderDefaultModelOptions() {
      if (!lastModelsPayload) return;

      const byId = modelsById(lastModelsPayload);
      const enabled = new Set(Array.isArray(lastModelsPayload.enabledModels) ? lastModelsPayload.enabledModels : []);

      // only enabled models as options, in order
      const ordered = computeOrderedIds(lastModelsPayload).filter(id => enabled.has(id) && !!byId[id]);

      defaultModelSelect.innerHTML = "";

      for (const id of ordered) {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = byId[id]?.name || id;
        defaultModelSelect.appendChild(opt);
      }

      // keep selection if possible
      const desired = lastSettings?.defaultModel;
      if (desired && ordered.includes(desired)) {
        defaultModelSelect.value = desired;
      } else if (ordered.length) {
        defaultModelSelect.value = ordered[0];
      }
    }

    function syncStartupUI(settings) {
      const restore = !!settings?.restoreLastActive;
      restoreLastToggle.checked = restore;
      defaultModelRow.style.display = restore ? "none" : "flex";

      renderDefaultModelOptions();

      if (!restore) {
        const current = settings?.defaultModel;
        const values = Array.from(defaultModelSelect.options).map(o => o.value);
        if (current && values.includes(current)) {
          defaultModelSelect.value = current;
        } else if (values.length) {
          defaultModelSelect.value = values[0];
        }
      }
    }

    restoreLastToggle.addEventListener("change", async () => {
      const restore = !!restoreLastToggle.checked;
      defaultModelRow.style.display = restore ? "none" : "flex";
      await window.electronAPI.setAppSettings({ restoreLastActive: restore });
    });

    defaultModelSelect.addEventListener("change", async () => {
      await window.electronAPI.setAppSettings({ defaultModel: defaultModelSelect.value });
    });

    // -----------------------------
    // Models page: render + wiring
    // -----------------------------
    const modelsListEl = document.getElementById("modelsList");
    const addModelBtn = document.getElementById("addModelBtn");
    const addModelForm = document.getElementById("addModelForm");
    const addModelName = document.getElementById("addModelName");
    const addModelUrl = document.getElementById("addModelUrl");
    const saveAddBtn = document.getElementById("saveAddBtn");
    const cancelAddBtn = document.getElementById("cancelAddBtn");
    const modelsErrorEl = document.getElementById("modelsError");

    function showModelsError(msg) {
      if (!msg) {
        modelsErrorEl.style.display = "none";
        modelsErrorEl.textContent = "";
        return;
      }
      modelsErrorEl.style.display = "block";
      modelsErrorEl.textContent = msg;
    }

    function setAddFormOpen(open) {
      showModelsError("");
      addModelForm.style.display = open ? "block" : "none";
      if (open) {
        addModelName.focus();
      } else {
        addModelName.value = "";
        addModelUrl.value = "";
      }
    }

    addModelBtn.addEventListener("click", () => {
      const isOpen = addModelForm.style.display === "block";
      setAddFormOpen(!isOpen);
    });

    cancelAddBtn.addEventListener("click", () => {
      setAddFormOpen(false);
    });

    function renderModelsList(payload) {
      const byId = modelsById(payload);
      const enabled = new Set(Array.isArray(payload?.enabledModels) ? payload.enabledModels : []);
      const ordered = computeOrderedIds(payload);

      modelsListEl.innerHTML = "";

      for (const id of ordered) {
        const m = byId[id];
        if (!m) continue;

        const row = document.createElement("div");
        row.className = "checkrow";
        row.dataset.id = id;

        const leftLabel = document.createElement("label");

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.dataset.model = id;
        cb.checked = enabled.has(id);

        const leftCol = document.createElement("div");
        leftCol.className = "left";

        const nameLine = document.createElement("div");
        nameLine.textContent = m.name || id;

        const urlLine = document.createElement("div");
        urlLine.className = "subhint";
        urlLine.textContent = m.url || "";

        leftCol.appendChild(nameLine);
        leftCol.appendChild(urlLine);

        leftLabel.appendChild(cb);
        leftLabel.appendChild(leftCol);

        const right = document.createElement("div");
        right.className = "right";

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.title = id;
        hint.textContent = id;

        right.appendChild(hint);

        // Delete (ALL models now)
        const del = document.createElement("button");
        del.className = "icon-btn danger";
        del.type = "button";
        del.title = "Delete model";
        del.textContent = "×";

        del.addEventListener("click", async () => {
          const ok = window.confirm(`Delete model "${m.name}"?`);
          if (!ok) return;

          showModelsError("");

          try {
            const res = await window.electronAPI.deleteAppModel(id);
            if (!res?.ok) {
              showModelsError(res?.error || "Failed to delete model.");
            }
          } catch {
            showModelsError("Failed to delete model.");
          }
        });

        right.appendChild(del);

        // Enable/disable
        cb.addEventListener("change", async () => {
          const cbs = Array.from(modelsListEl.querySelectorAll('input[type="checkbox"][data-model]'));
          const enabledModels = cbs.filter(x => x.checked).map(x => x.dataset.model);

          showModelsError("");

          try {
            await window.electronAPI.setAppSettings({ enabledModels });
          } catch {
            showModelsError("Failed to update enabled models.");
          }
        });

        row.appendChild(leftLabel);
        row.appendChild(right);

        modelsListEl.appendChild(row);
      }
    }

    saveAddBtn.addEventListener("click", async () => {
      const name = (addModelName.value || "").trim();
      const url = (addModelUrl.value || "").trim();

      showModelsError("");

      if (!name) {
        showModelsError("Model name is required.");
        return;
      }
      if (!/^https:\/\//i.test(url)) {
        showModelsError("Model URL must start with https://");
        return;
      }

      saveAddBtn.disabled = true;

      try {
        const res = await window.electronAPI.addAppModel({ name, url });
        if (!res?.ok) {
          showModelsError(res?.error || "Failed to add model.");
        } else {
          setAddFormOpen(false);
        }
      } catch {
        showModelsError("Failed to add model.");
      } finally {
        saveAddBtn.disabled = false;
      }
    });

    // -----------------------------
    // Behavior wiring
    // -----------------------------
    const confirmBeforeStopToggle = document.getElementById("confirmBeforeStopToggle");
    const hardReloadToggle = document.getElementById("hardReloadToggle");

    function syncBehaviorUI(settings) {
      if (typeof settings?.confirmBeforeStop === "boolean") {
        confirmBeforeStopToggle.checked = settings.confirmBeforeStop;
      }
      if (typeof settings?.hardReloadOnRefresh === "boolean") {
        hardReloadToggle.checked = settings.hardReloadOnRefresh;
      }
    }

    confirmBeforeStopToggle.addEventListener("change", async () => {
      await window.electronAPI.setAppSettings({ confirmBeforeStop: !!confirmBeforeStopToggle.checked });
    });

    hardReloadToggle.addEventListener("change", async () => {
      await window.electronAPI.setAppSettings({ hardReloadOnRefresh: !!hardReloadToggle.checked });
    });

    // -----------------------------
    // About wiring
    // -----------------------------
    async function loadAboutInfo() {
      try {
        const info = await window.electronAPI.getAppInfo();
        if (info?.appName) document.getElementById("aboutAppName").textContent = info.appName;
        if (info?.appVersion) document.getElementById("aboutAppVersion").textContent = info.appVersion;
        if (info?.electronVersion) document.getElementById("aboutElectronVersion").textContent = info.electronVersion;
      } catch (err) { console.warn("Multi-AI-Wrapper(settings): loadAboutInfo failed", err); }
    }

    // -----------------------------
    // Initial load + live sync
    // -----------------------------
    async function initialLoad() {
      try {
        lastSettings = await window.electronAPI.getAppSettings();
        if (lastSettings?.themeSource) setThemeRadios(lastSettings.themeSource);
        syncBehaviorUI(lastSettings);
      } catch (err) { console.warn("Multi-AI-Wrapper(settings): initial getAppSettings failed", err); }

      try {
        lastModelsPayload = await window.electronAPI.getAppModels();
        renderModelsList(lastModelsPayload);
      } catch (err) { console.warn("Multi-AI-Wrapper(settings): initial getAppModels failed", err); }

      if (lastSettings) {
        syncStartupUI(lastSettings);
      }

      loadAboutInfo();
    }

    window.electronAPI.onAppSettingsChanged(settings => {
      lastSettings = settings;
      syncStartupUI(settings);
      syncBehaviorUI(settings);
    });

    window.electronAPI.onAppModelsChanged(payload => {
      lastModelsPayload = payload;
      renderModelsList(payload);

      if (lastSettings) {
        syncStartupUI(lastSettings);
      } else {
        renderDefaultModelOptions();
      }
    });

    initialLoad();
  </script>
</body>
</html>
